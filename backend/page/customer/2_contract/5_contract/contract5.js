const express = require('express');
const router = express.Router();
const contract5 = require('../../../../models/contract5'); 

// ข้อความสัญญาที่ไม่สามารถแก้ไขได้
const contractText5 = `
สัญญาเช่าเกมออนไลน์

ระหว่าง ผู้ให้เช่า และ ผู้เช่า ซึ่งเรียกรวมกันว่า "คู่สัญญา" ทั้งสองฝ่ายได้ตกลงทำสัญญากันในข้อตกลงดังต่อไปนี้:

1. ข้อตกลงเกี่ยวกับการเช่าเกมออนไลน์  
1.1 รายละเอียดเกมที่เช่า  
ผู้ให้เช่ายินยอมให้ผู้เช่าทำการเช่าเกมออนไลน์ทั้งหมดที่มีในคลังของผู้ให้เช่า ภายใต้เงื่อนไขและข้อกำหนดที่ระบุไว้ในสัญญานี้

1.2 ระยะเวลาการเช่า  
ระยะเวลาการเช่าเกมจะคำนวณตั้งแต่วันที่เริ่มต้นจนถึงวันที่ผู้เช่าชำระค่าบริการครบถ้วนและคืนเกมตามข้อกำหนดของสัญญา ทั้งนี้ สัญญาจะถือว่าสิ้นสุดลงเมื่อผู้เช่าได้ดำเนินการชำระค่าบริการครบถ้วนและคืนเกมเรียบร้อยแล้วเท่านั้น

2. หลักประกันและการชำระเงิน  
2.1 หลักประกัน  
ผู้เช่าตกลงให้อุปกรณ์อิเล็กทรอนิกส์ที่ใช้ในการเช่าเกมอยู่ภายใต้การควบคุมและจัดการโดยระบบ MDM (Mobile Device Management) ซึ่งจัดการโดยผู้ให้เช่า โดยผู้ให้เช่าจะดำเนินการติดตั้งซอฟต์แวร์ MDM บนอุปกรณ์ดังกล่าวเพื่อใช้เป็นหลักประกันในการเช่าเกม

2.2 การบริหารจัดการอุปกรณ์ผ่านระบบ MDM  
อุปกรณ์อิเล็กทรอนิกส์ที่ใช้ในการเช่าเกมจะอยู่ภายใต้การควบคุมโดยระบบ MDM ที่ผู้ให้เช่าเป็นผู้จัดการ เพื่อรักษาความปลอดภัย ควบคุมการใช้งาน และป้องกันการละเมิดสิทธิ์ตลอดระยะเวลาการเช่า

2.3 การคืนหลักประกัน  
หลักประกันจะได้รับการคืนให้แก่ผู้เช่าเมื่อผู้เช่าชำระค่าบริการทั้งหมดครบถ้วนตามที่ระบุในสัญญา และคืนเกมภายในระยะเวลาที่กำหนด พร้อมทั้งดำเนินการถอนระบบ MDM ออกจากอุปกรณ์ที่ใช้ในการเช่าเรียบร้อยแล้ว

2.4 การไม่ชำระค่าบริการและการยึดหลักประกัน  
2.4.1 ในกรณีที่ผู้เช่าไม่ชำระค่าบริการตามที่ระบุไว้ในสัญญาภายในระยะเวลาที่กำหนด ไม่ว่าทั้งหมดหรือบางส่วน ผู้ให้เช่ามีสิทธิ์ดำเนินการเรียกเก็บเงินค้างชำระ รวมถึงยึดหลักประกันตามข้อกำหนดในสัญญานี้ โดยไม่จำเป็นต้องได้รับความยินยอมเพิ่มเติมจากผู้เช่า  
2.4.2 การยึดหลักประกันตามข้อ 2.4.1 อาจรวมถึงการควบคุมอุปกรณ์ผ่านระบบ MDM การระงับการใช้งานอุปกรณ์ และ/หรือการดำเนินการทางกฎหมายที่จำเป็น เพื่อคุ้มครองสิทธิ์และผลประโยชน์ของผู้ให้เช่า โดยผู้ให้เช่าสามารถดำเนินการดังกล่าวได้ทันทีหลังเกิดการผิดนัดชำระเงิน

2.5 ความเสียหายหรือการจำหน่ายหลักประกัน  
2.5.1 หากผู้เช่ากระทำการใด ๆ อันส่งผลให้หลักประกันเกิดความเสียหาย สูญหาย ถูกทำลาย หรือถูกนำไปจำหน่ายโดยไม่ได้รับความยินยอมเป็นลายลักษณ์อักษรจากผู้ให้เช่า ผู้ให้เช่ามีสิทธิ์ดำเนินการทางกฎหมายทั้งทางแพ่งและ/หรืออาญา เพื่อเรียกร้องค่าเสียหายและคุ้มครองสิทธิ์ตามกฎหมาย  
2.5.2 ในกรณีที่มีบุคคลภายนอกเป็นผู้รับซื้อหรือรับโอนหลักประกันดังกล่าว โดยทราบหรือควรทราบว่าเป็นทรัพย์ที่อยู่ภายใต้สัญญาเช่า ผู้ให้เช่ามีสิทธิ์ดำเนินคดีกับบุคคลดังกล่าวตามที่กฎหมายบัญญัติ

2.6 วิธีการชำระเงิน  
ค่าธรรมเนียมการเช่าสามารถชำระผ่านช่องทางที่ผู้ให้เช่ากำหนด เช่น บัญชีธนาคาร หรือช่องทางการชำระเงินออนไลน์ต่าง ๆ โดยผู้ให้เช่าจะต้องแจ้งข้อมูลการชำระเงินให้ผู้เช่าทราบอย่างชัดเจน

2.7 ค่าใช้จ่ายในการติดตามและดำเนินคดี 
หากผู้เช่าผิดนัดชำระค่าเช่าหรือกระทำการใด ๆ อันเป็นการผิดสัญญา และผู้ให้เช่าต้องเสียค่าใช้จ่ายในการติดตาม ทวงถาม หรือดำเนินการทางกฎหมายเพื่อบังคับตามสิทธิของผู้ให้เช่า ไม่ว่าจะเป็น ค่าทนายความ ค่าเดินทาง ค่าธรรมเนียมศาล ค่าผู้ติดตามทวงถาม หรือค่าใช้จ่ายอื่นใดอันสมควร ผู้เช่าตกลงจะเป็นผู้รับผิดชอบชำระค่าใช้จ่ายทั้งหมดดังกล่าวให้แก่ผู้ให้เช่า

3. การใช้งานและการคืนเกม  
3.1 การคืนเกมและการสิ้นสุดสัญญา  
ผู้เช่าตกลงคืนเกมภายในระยะเวลาที่ระบุไว้ในสัญญา และต้องชำระค่าบริการทั้งหมดให้ครบถ้วน หากผู้เช่าไม่ชำระเงินครบถ้วนตามข้อกำหนดดังกล่าว สัญญาจะยังไม่ถือว่าสิ้นสุดโดยสมบูรณ์ และผู้เช่ายังคงมีภาระผูกพันตามสัญญานี้

3.2 ข้อห้ามในการกระทำกับเกม  
ผู้เช่าห้ามกระทำการทำลาย ดัดแปลง หรือแก้ไขเนื้อหาและซอฟต์แวร์ของเกม รวมถึงห้ามละเมิดลิขสิทธิ์หรือสิทธิ์อื่นใดที่เกี่ยวข้องกับเกม

4. ข้อจำกัดความรับผิด  
4.1 ผู้ให้เช่าจะไม่รับผิดชอบต่อความเสียหายใด ๆ ที่เกิดขึ้นจากการใช้งานเกมอันเกิดจากความผิดพลาดของระบบ, อินเทอร์เน็ต, หรือการใช้งานผิดวิธีโดยผู้เช่า  
4.2 หากเกมเกิดปัญหาทางเทคนิคที่ไม่สามารถเล่นได้ ผู้ให้เช่าจะดำเนินการแก้ไขให้โดยเร็ว แต่ไม่ต้องรับผิดชอบต่อค่าเสียโอกาส หรือค่าเสียหายอื่น ๆ ของผู้เช่า

5. การยกเลิกสัญญา  
5.1 การยกเลิกสัญญาก่อนกำหนด  
สัญญานี้ไม่สามารถยกเลิกก่อนกำหนดได้ เว้นแต่จะเกิดกรณีละเมิดข้อกำหนดในสัญญา หรือมีเหตุสุดวิสัยที่ทำให้ไม่สามารถปฏิบัติตามสัญญาได้ โดยจะต้องได้รับการตกลงจากคู่สัญญาทั้งสองฝ่าย  

5.2 การยกเลิกสัญญาเนื่องจากการละเมิด  
ในกรณีที่ฝ่ายใดฝ่ายหนึ่งละเมิดข้อกำหนดในสัญญานี้ ฝ่ายที่ได้รับผลกระทบมีสิทธิ์ยกเลิกสัญญาทันทีโดยไม่ต้องคืนค่าธรรมเนียมหรือหลักประกันใด ๆ

6. ข้อพิพาทและการตีความสัญญา  
6.1 หากเกิดข้อพิพาทที่เกี่ยวข้องกับสัญญานี้ คู่สัญญาตกลงจะเจรจาเพื่อหาข้อยุติร่วมกันก่อน หากไม่สามารถตกลงกันได้ ให้มีการดำเนินคดีในศาลที่ผู้ให้เช่าตั้งอยู่  
6.2 ข้อความใด ๆ ในสัญญานี้ หากมีความไม่ชัดเจน ให้นำมาตีความโดยคำนึงถึงเจตนารมณ์ของคู่สัญญาและหลักความเป็นธรรม

7. ข้อกำหนดเพิ่มเติม  
การเปลี่ยนแปลงเงื่อนไขในสัญญานี้ จะต้องกระทำเป็นลายลักษณ์อักษรและได้รับความยินยอมจากทั้งสองฝ่าย  

8. การยอมรับเงื่อนไข  
ผู้เช่าตกลงยอมรับข้อกำหนดและเงื่อนไขทั้งหมดในสัญญานี้โดยสมบูรณ์ การติ๊กเครื่องหมายในช่อง "ยินยอม" ถือเป็นการยอมรับและตกลงตามข้อกำหนดในสัญญานี้ทั้งหมด
`;


//เเสดงสัญญา
router.get('/5', (req, res) => {  
    res.json({ text: contractText5 });
});


//บันทึก
router.post('/log-next-button', async (req, res) => {
  try {
    // ดึง IP Address และ User Agent
    const ipAddress = req.ip || req.headers['x-forwarded-for'] || req.connection.remoteAddress;
    const userAgent = req.headers['user-agent'];

    // รับค่าจาก body
    const {
      contract_id,
      status = 'รออนุมัติ', // ค่า default
      approver_id_card,
      approver_position
    } = req.body;

    // ตรวจสอบว่า contract_id ซ้ำหรือไม่
    const existing = await contract5.findOne({ contract_id });
    if (existing) {
      return res.status(400).json({ message: 'contract_id นี้มีอยู่ในระบบแล้ว' });
    }

    // เตรียมข้อมูลสำหรับบันทึก
    const newLog = new contract5({
      contract_id,
      status,
      approver_id_card,
      approver_position,
      ipAddress,
      userAgent
    });

    await newLog.save();

    res.status(201).json({
      success: true,
      message: 'บันทึกข้อมูลสำเร็จ',
      data: newLog
    });
  } catch (error) {
    console.error('Error logging button click:', error);
    res.status(500).json({
      success: false,
      message: 'เกิดข้อผิดพลาดในการบันทึกข้อมูล',
      error
    });
  }
});




module.exports = router;
